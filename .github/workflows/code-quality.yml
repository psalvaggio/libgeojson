name: Code Quality

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  clang-format:
    name: Clang-Format Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format

    - name: Check formatting
      run: |
        find include tests -name '*.h' -o -name '*.cpp' | \
        xargs clang-format -style=file --dry-run --Werror

  clang-tidy:
    name: Clang-Tidy Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-tidy cmake ninja-build nlohmann-json3-dev

    - name: Configure CMake
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

    - name: Run clang-tidy
      run: |
        if [ -d tests ]; then
          find tests -name '*.cpp' | \
          xargs clang-tidy -p build --warnings-as-errors=''
        fi

  cppcheck:
    name: Cppcheck Static Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install cppcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck

    - name: Run cppcheck
      run: |
        cppcheck --enable=all --inconclusive --suppress=missingIncludeSystem \
          --error-exitcode=1 --inline-suppr \
          -I include \
          tests/ 2>&1 | tee cppcheck-report.txt || true

    - name: Upload cppcheck report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cppcheck-report
        path: cppcheck-report.txt
